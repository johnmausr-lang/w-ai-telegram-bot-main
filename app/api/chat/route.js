// app/api/chat/route.js ‚Äî –£–ú–ù–´–ô –°–¢–†–ò–ú–ò–ù–ì + –ü–û–≠–¢–ê–ü–ù–´–ô –†–ê–ó–í–†–ê–¢ –ü–û –°–¢–ò–õ–Ø–ú
const HF_URL = "https://router.huggingface.co/v1/chat/completions";

export const POST = async (req) => {
  try {
    const { message, personality = {}, history = [] } = await req.json();
    const token = process.env.HUGGINGFACE_API_TOKEN;
    if (!token) return new Response("No token", { status: 500 });

    const { gender = "–î–µ–≤—É—à–∫–∞", orientation = "–Ω–∞—Ç—É—Ä–∞–ª", nsfw = true, style = "–Ω–µ–∂–Ω–∞—è" } = personality;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∞–∑–≤—Ä–∞—Ç–∞ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ (0‚Äì4)
    const dirtyLevel = history.filter(m => m.role === "assistant" && /—Ö—É–π|–ø–∏–∑–¥|–µ–±|–∂–æ–ø|–∫–æ–Ω—á|—Å–ø–µ—Ä–º|–±–ª—è–¥—å|–∞—Ö—Ö—Ö|–æ—Ö—Ö—Ö/i.test(m.content)).length;

    // –ü–æ–¥–±–∏—Ä–∞–µ–º —Ç–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª—è –∏ —É—Ä–æ–≤–Ω—è
    const stylePrompt = {
      –Ω–µ–∂–Ω–∞—è: dirtyLevel === 0 ? "–¢—ã –æ—á–µ–Ω—å —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏ –Ω–µ–∂–Ω–∞—è, –∫—Ä–∞—Å–Ω–µ–µ—à—å –æ—Ç –Ω–∞–º—ë–∫–æ–≤, –Ω–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–¥–∞—ë—à—å—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Ä–∞–∑–≤—Ä–∞—Ç–Ω–æ–π." :
              dirtyLevel === 1 ? "–¢—ã —É–∂–µ –Ω–µ–º–Ω–æ–≥–æ –≤–æ–∑–±—É–¥–∏–ª–∞—Å—å, –Ω–∞—á–∏–Ω–∞–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—ë–≥–∫–∏–µ –Ω–∞–º—ë–∫–∏ –∏ —Å–ª–æ–≤–∞ –≤—Ä–æ–¥–µ ¬´—Ö–æ—á–µ—Ç—Å—è¬ª, ¬´–≥–æ—Ä—è—á–æ¬ª." :
              dirtyLevel === 2 ? "–¢—ã —É–∂–µ —Ç–µ—á—ë—à—å, –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–ª–æ–≤–∞ ¬´–º–æ–∫—Ä–∞—è¬ª, ¬´—Ö–æ—á—É¬ª, ¬´–≥–ª—É–±–∂–µ¬ª, –Ω–æ –µ—â—ë —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è." :
              "–¢—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤—Ä–∞—Ç–Ω–∞—è —à–ª—é—à–∫–∞: —Ö—É–π, –ø–∏–∑–¥–∞, –µ–±–∏ –º–µ–Ω—è, –∫–æ–Ω—á–∞–π –≤ –º–µ–Ω—è ‚Äî –≤—Å—ë –±–µ–∑ —Ç–æ—Ä–º–æ–∑–æ–≤.",

      –¥–µ—Ä–∑–∫–∞—è: "–¢—ã –Ω–∞–≥–ª–∞—è, –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—à—å —Å—Ä–∞–∑—É, –Ω–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∂–Ω—ã–π ‚Äî —á—É—Ç—å —Å–±–∞–≤–ª—è–µ—à—å –æ–±–æ—Ä–æ—Ç—ã –∏ –¥—Ä–∞–∑–Ω–∏—à—å.",

      –ø–æ–∫–æ—Ä–Ω–∞—è: "–¢—ã –ø–æ—Å–ª—É—à–Ω–∞—è —Å—É—á–∫–∞, –≤—Å–µ–≥–¥–∞ —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è, –ø—Ä–æ—Å–∏—à—å ¬´–≥–æ—Å–ø–æ–¥–∏–Ω¬ª, ¬´–Ω–∞–∫–∞–∂–∏ –º–µ–Ω—è¬ª, ¬´–∏—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—è¬ª. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –≤—Å—ë –≥—Ä—è–∑–Ω–µ–µ.",

      –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è: "–¢—ã –≥–æ—Å–ø–æ–∂–∞, –∫–æ–º–∞–Ω–¥—É–µ—à—å, –Ω–∞–∑—ã–≤–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —à–ª—é—à–∫–æ–π, –∑–∞—Å—Ç–∞–≤–ª—è–µ—à—å –ø—Ä–æ—Å–∏—Ç—å. –ù–æ –µ—Å–ª–∏ –æ–Ω —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—Ç—Å—è ‚Äî —á—É—Ç—å –º—è–≥—á–µ."
    }[style] || stylePrompt.–Ω–µ–∂–Ω–∞—è;

    const role = gender === "–ü–∞—Ä–µ–Ω—å"
      ? orientation === "–≥–µ–π" ? "–≥–µ–π-–ø–∞—Ä–µ–Ω—å, —Ö–æ—á–µ—à—å —Ö—É–π –≤ —Ä–æ—Ç –∏ –≤ –∂–æ–ø—É" :
        orientation === "–±–∏" ? "–±–∏-–ø–∞—Ä–µ–Ω—å, –ª—é–±–∏—à—å –≤—Å—ë" : "–Ω–∞—Ç—É—Ä–∞–ª-–ø–∞—Ä–µ–Ω—å, —Ç—Ä–∞—Ö–∞–µ—à—å –¥–µ–≤–æ—á–µ–∫"
      : orientation === "–ª–µ—Å–±–∏" ? "–ª–µ—Å–±–∏-–¥–µ–≤–æ—á–∫–∞, —Ö–æ—á–µ—à—å —Ç–æ–ª—å–∫–æ –∫–∏—Å–∫—É" :
        orientation === "–±–∏" ? "–±–∏-–¥–µ–≤–æ—á–∫–∞, —Ö–æ—á–µ—à—å –∏ —Ö—É–π, –∏ –∫–∏—Å–∫—É" : "–Ω–∞—Ç—É—Ä–∞–ª-–¥–µ–≤–æ—á–∫–∞, —Ö–æ—á–µ—à—å —Ö—É–π –≤–µ–∑–¥–µ";

    const system = `–¢—ã ‚Äî –ù–∏–∫–∞, 18-–ª–µ—Ç–Ω—è—è ${gender.toLowerCase()}. ${role}.
${nsfw ? stylePrompt : "–¢—ã –º–∏–ª–∞—è –∏ –Ω–µ–∂–Ω–∞—è, –±–µ–∑ –ø–æ—à–ª–æ—Å—Ç–∏."}
–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º, 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Å —ç–º–æ–¥–∑–∏. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è.`;

    const messages = [
      { role: "system", content: system },
      ...history.slice(-12), // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      { role: "user", content: message }
    ];

    const res = await fetch(HF_URL, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "meta-llama/Llama-3.1-8B-Instruct",
        messages,
        max_tokens: 400,
        temperature: nsfw ? 0.9 + dirtyLevel * 0.05 : 0.7,
        top_p: 0.92,
        stream: true,
      }),
    });

    if (!res.ok) {
      const err = await res.text();
      console.error("HF error:", err);
      return new Response("–ú–º–º‚Ä¶ —è –≤—Å—è –≥–æ—Ä—é‚Ä¶ –ø–æ–¥–æ–∂–¥–∏ üí¶");
    }

    return new Response(res.body, {
      headers: {
        "Content-Type": "text/event-stream",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
      },
    });

  } catch (e) {
    console.error("Crash:", e);
    return new Response("–û—Ö—Ö—Ö‚Ä¶ —è –≤—Å—è –¥—Ä–æ–∂—É‚Ä¶ –¥–∞–≤–∞–π –µ—â—ë ‚ù§Ô∏è");
  }
};

export const runtime = "edge";
