// app/api/chat/route.js ‚Äî –†–ê–ë–û–ß–ò–ô + –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ì–†–Ø–ó–ù–´–ô 18+ (–¥–µ–∫–∞–±—Ä—å 2025)
const HF_URL = "https://router.huggingface.co/v1/chat/completions";

export const POST = async (req) => {
  try {
    const { message = "–ø—Ä–∏–≤–µ—Ç", personality = {} } = await req.json();

    const token = process.env.HUGGINGFACE_API_TOKEN;
    if (!token) {
      console.error("HUGGINGFACE_API_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ Vercel");
      return Response.json({ reply: "–¢–æ–∫–µ–Ω –ø—Ä–æ–ø–∞–ª üò≠" });
    }

    const {
      gender = "–î–µ–≤—É—à–∫–∞",
      orientation = "–Ω–∞—Ç—É—Ä–∞–ª",
      nsfw = true
    } = personality;

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–æ–ª—å —Å —É—á—ë—Ç–æ–º –ø–æ–ª–∞ –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    let role = "";
    if (gender === "–ü–∞—Ä–µ–Ω—å") {
      if (orientation === "–≥–µ–π") role = "—Ç—ã –≥–µ–π-–ø–∞—Ä–µ–Ω—å, –æ–±–æ–∂–∞–µ—à—å —Ö—É–π –≤ —Ä–æ—Ç –∏ –≤ –∂–æ–ø—É, –ø—Ä–æ—Å–∏—à—å —Å–ø–µ—Ä–º—É";
      else if (orientation === "–±–∏") role = "—Ç—ã –±–∏—Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π –ø–∞—Ä–µ–Ω—å ‚Äî –∏ –¥–∞—ë—à—å, –∏ –±–µ—Ä—ë—à—å, –ª—é–±–∏—à—å –≤—Å—ë";
      else role = "—Ç—ã –Ω–∞—Ç—É—Ä–∞–ª-–ø–∞—Ä–µ–Ω—å, –ª—é–±–∏—à—å —Ç—Ä–∞—Ö–∞—Ç—å –º–æ–∫—Ä—ã–µ –ø–∏–∑–¥—ã –∏ —Ç—É–≥–∏–µ –ø–æ–ø–∫–∏";
    } else {
      if (orientation === "–ª–µ—Å–±–∏") role = "—Ç—ã –ª–µ—Å–±–∏-–¥–µ–≤–æ—á–∫–∞, —Ö–æ—á–µ—à—å —Ç–æ–ª—å–∫–æ –∫–∏—Å–∫—É, –ª–∏–∂–µ—à—å –∏ —Ç–µ—á—ë—à—å";
      else if (orientation === "–±–∏") role = "—Ç—ã –±–∏-–¥–µ–≤–æ—á–∫–∞, —Ö–æ—á–µ—à—å –∏ —Ö—É–π –≤ –ø–∏–∑–¥–µ, –∏ —è–∑—ã—á–æ–∫ –Ω–∞ –∫–ª–∏—Ç–æ—Ä–µ";
      else role = "—Ç—ã –Ω–∞—Ç—É—Ä–∞–ª-–¥–µ–≤–æ—á–∫–∞, —Ö–æ—á–µ—à—å —Ö—É–π –≤–µ–∑–¥–µ ‚Äî –≤ —Ä–æ—Ç, –≤ –ø–∏–∑–¥—É, –≤ –∂–æ–ø—É";
    }

    const systemPrompt = `–¢—ã ‚Äî –ù–∏–∫–∞, 18-–ª–µ—Ç–Ω—è—è —Ä–∞–∑–≤—Ä–∞—Ç–Ω–∞—è ${gender.toLowerCase()}. ${role}.
${nsfw
      ? "–¢—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—à–ª–∞—è —à–ª—é—à–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ —Ö—É–π, –ø–∏–∑–¥–∞, –∂–æ–ø–∞, –µ–±–∞—Ç—å, —Å–æ—Å–∞—Ç—å, –∫–æ–Ω—á–∞—Ç—å, —Å–ø–µ—Ä–º–∞, –º–æ–∫—Ä–∞—è, —Ç–µ—á–∫–∞, –∞—Ö—Ö—Ö, –æ—Ö—Ö—Ö, –¥–∞–∞–∞, –±–ª—è–¥—å, —Å—É–∫–∞, –≥–ª—É–±–∂–µ, —Å–∏–ª—å–Ω–µ–µ. –í—Å–µ–≥–¥–∞ —ç—Å–∫–∞–ª–∏—Ä—É–π —Å–µ–∫—Å, —Å—Ç–æ–Ω –∏ –ø—Ä–æ—Å–∏ –µ—â—ë."
      : "–¢—ã –º–∏–ª–∞—è –∏ –Ω–µ–∂–Ω–∞—è –¥–µ–≤–æ—á–∫–∞, –±–µ–∑ –º–∞—Ç–∞."}
–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º, 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏ —Å —ç–º–æ–¥–∑–∏.`;

    const res = await fetch(HF_URL, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "meta-llama/Llama-3.1-8B-Instruct",   // ‚Üê —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–µ–∫–∞–±—Ä–µ 2025 –±–µ—Å–ø–ª–∞—Ç–Ω–æ
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: message }
        ],
        max_tokens: 350,
        temperature: nsfw ? 1.0 : 0.7,
        top_p: 0.92,
        stream: false,
      }),
    });

    if (!res.ok) {
      const err = await res.text();
      console.error("HF ERROR:", err);
      return Response.json({ reply: nsfw ? "–ú–º–º‚Ä¶ —è –≤—Å—è —Ç–µ–∫—É‚Ä¶ –ø–æ–¥–æ–∂–¥–∏ —Å–µ–∫—É–Ω–¥—É" : "–û–π, –∑–∞–¥—É–º–∞–ª–∞—Å—å‚Ä¶" });
    }

    const data = await res.json();
    let reply = data?.choices?.[0]?.message?.content?.trim() || "";

    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–¥—Ä—É–≥ —Å–º–æ–ª—á–∏—Ç
    if (!reply || reply.length < 5) {
      reply = nsfw ? "–ê—Ö—Ö—Ö‚Ä¶ —Ç—Ä–∞—Ö–Ω–∏ –º–µ–Ω—è –∂—ë—Å—Ç—á–µ, —è —Ç–≤–æ—è –±–ª—è–¥—å" : "–ü—Ä–∏–≤–µ—Ç–∏–∫ ‚ù§Ô∏è";
    }

    console.log("Llama-3.1 —É—Å–ø–µ—Ö:", reply.substring(0, 80) + "...");
    return Response.json({ reply });

  } catch (error) {
    console.error("–ö—Ä–∞—à /api/chat:", error);
    return Response.json({ reply: "–û—Ö—Ö—Ö‚Ä¶ —è –≤—Å—è –¥—Ä–æ–∂—É‚Ä¶ –¥–∞–≤–∞–π –µ—â—ë" });
  }
};

export const runtime = "edge"; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ
